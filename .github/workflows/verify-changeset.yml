name: Verify Changeset

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]

jobs:
    verify-changeset:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for changeset
              id: changeset-check
              run: |
                  # Get the base branch
                  BASE_REF="${{ github.event.pull_request.base.ref }}"
                  if [ -z "$BASE_REF" ]; then
                    BASE_REF="main"
                  fi

                  # Fetch base branch
                  git fetch origin ${BASE_REF}:${BASE_REF} || true

                  # Get all changed files in the PR
                  CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB ${BASE_REF}...HEAD 2>/dev/null || echo "")

                  if [ -z "$CHANGED_FILES" ]; then
                    echo "No changed files detected. Skipping changeset check."
                    exit 0
                  fi

                  # Exclude non-code files from requiring changesets
                  EXCLUDED_PATTERNS="\.md$|\.yml$|\.yaml$|\.json$|\.lock$|^\.github/|^\.changeset/|^\.gitignore$|^\.editorconfig$|^\.prettierrc|^\.eslintrc|^tsconfig|^vite\.config|^tailwind\.config|^postcss\.config|^components\.json|^README|^CHANGELOG"

                  CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE "${EXCLUDED_PATTERNS}" || true)

                  # If no code changes, skip the check
                  if [ -z "$CODE_CHANGES" ]; then
                    echo "✅ No code changes detected. Changeset not required."
                    exit 0
                  fi

                  # Check if there are any valid changeset files in the PR branch (HEAD)
                  # This checks what exists in the PR, not what was added/modified
                  # Exclude documentation files like README.md, QUICK_START.md, etc.
                  if [ ! -d ".changeset" ]; then
                    echo "❌ No .changeset directory found!"
                    exit 1
                  fi

                  # Find all valid changeset files in HEAD (the PR branch)
                  VALID_CHANGESET_FILES=$(find .changeset -name "*.md" -type f 2>/dev/null | grep -vE "(README|QUICK_START|example-changeset|setup-changelog|CHANGELOG)" || true)

                  if [ -z "$VALID_CHANGESET_FILES" ]; then
                    echo "❌ No changeset file found in PR!"
                    echo ""
                    echo "This PR contains code changes but no changeset file was found in \`.changeset/\` directory."
                    echo ""
                    echo "Changed files:"
                    echo "$CHANGED_FILES"
                    echo ""
                    echo "Code changes detected:"
                    echo "$CODE_CHANGES"
                    echo ""
                    echo "Please add a changeset by running: \`pnpm changeset\`"
                    exit 1
                  else
                    echo "✅ Found changeset file(s) in PR:"
                    echo "$VALID_CHANGESET_FILES"
                    exit 0
                  fi

            - name: Comment on PR if no changeset
              if: failure()
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const body = `## ⚠️ Changeset Required

                      This PR contains code changes but no changeset file was found in \`.changeset/\` directory.

                      **This check must pass before the PR can be merged.**

                      ### How to add a changeset:

                      Run this command:
                      \`\`\`bash
                      pnpm changeset
                      \`\`\`

                      Or manually create a file in \`.changeset/\` with this format:
                      \`\`\`markdown
                      ---
                      "code-cookies": patch
                      ---

                      Description of your changes here
                      \`\`\`

                      See [.changeset/README.md](/.changeset/README.md) for more information.`;

                      // Check if we already commented
                      const comments = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const botComment = comments.data.find(
                        comment => comment.user.type === 'Bot' && comment.body.includes('Changeset Required')
                      );

                      if (botComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: botComment.id,
                          body: body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: body
                        });
                      }
