name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset files
        id: check-changeset
        run: |
          # Get the base branch from the PR event
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
          fi
          
          # Fetch the base branch to compare against
          git fetch origin ${BASE_REF}:${BASE_REF} || true
          
          # Get the list of changed files in the PR
          # Use HEAD^1 to compare against the base branch
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB ${BASE_REF}...HEAD 2>/dev/null || git diff --name-only --diff-filter=ACMRTUXB HEAD~1...HEAD 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files detected. Skipping changelog check."
            echo "has_changeset=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if there are any changeset files in the PR
          CHANGESET_FILES=$(echo "$CHANGED_FILES" | grep -E '^\.changeset/.*\.md$' || true)
          
          # Check if there are any changes outside of documentation, CI, or config files
          EXCLUDED_PATTERNS="\.md$|\.yml$|\.yaml$|\.json$|\.lock$|^\.github/|^\.changeset/|^\.gitignore$|^\.editorconfig$|^\.prettierrc|^\.eslintrc|^tsconfig|^vite\.config|^tailwind\.config|^postcss\.config|^components\.json|^README|^CHANGELOG"
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE "${EXCLUDED_PATTERNS}" || true)
          
          if [ -z "$CODE_CHANGES" ]; then
            echo "No code changes detected. Skipping changelog check."
            echo "has_changeset=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "$CHANGESET_FILES" ]; then
            echo "❌ No changeset file found!"
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changeset=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ Found changeset file(s):"
            echo "$CHANGESET_FILES"
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if no changeset
        if: steps.check-changeset.outputs.has_changeset == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ⚠️ Changelog Required
            
            This PR contains code changes but no changeset file was found.
            
            Please add a changeset file by running:
            \`\`\`bash
            pnpm changeset
            \`\`\`
            
            Or manually create a file in \`.changeset/\` directory with the following format:
            \`\`\`markdown
            ---
            "code-cookies": patch
            ---
            
            Description of your changes here
            \`\`\`
            
            See [.changeset/README.md](/.changeset/README.md) for more information.
            
            **This check must pass before the PR can be merged.**`;
            
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('Changelog Required')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if no changeset
        if: steps.check-changeset.outputs.has_changeset == 'false'
        run: |
          echo "::error::No changeset file found. Please add a changeset file to your PR."
          exit 1
