name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: changeset-check
        run: |
          # Check if there are code changes (exclude docs, config, CI files)
          EXCLUDED_PATTERNS="\.md$|\.yml$|\.yaml$|\.json$|\.lock$|^\.github/|^\.changeset/|^\.gitignore$|^\.editorconfig$|^\.prettierrc|^\.eslintrc|^tsconfig|^vite\.config|^tailwind\.config|^postcss\.config|^components\.json|^README|^CHANGELOG"

          BASE_REF="${{ github.event.pull_request.base.ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
          fi

          git fetch origin ${BASE_REF}:${BASE_REF} || true
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB ${BASE_REF}...HEAD 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files detected. Skipping changelog check."
            exit 0
          fi

          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE "${EXCLUDED_PATTERNS}" || true)

          if [ -z "$CODE_CHANGES" ]; then
            echo "No code changes detected. Skipping changelog check."
            exit 0
          fi

          # Check if changeset files exist in the PR
          # This follows the Changesets recommendation: https://github.com/changesets/changesets#checking-for-changesets
          CHANGESET_FILES=$(echo "$CHANGED_FILES" | grep -E '^\.changeset/.*\.md$' || true)

          if [ -z "$CHANGESET_FILES" ]; then
            echo "❌ No changeset file found in PR!"
            echo ""
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo ""
            echo "According to Changesets documentation, PRs with code changes must include a changeset."
            exit 1
          else
            echo "✅ Found changeset file(s):"
            echo "$CHANGESET_FILES"
            
            # Validate changeset format (basic check - file exists and has correct structure)
            for file in $CHANGESET_FILES; do
              if [ -f "$file" ]; then
                if grep -q '^---$' "$file" && grep -q '"code-cookies"' "$file"; then
                  echo "  ✓ $file has valid format"
                else
                  echo "  ⚠ $file may have incorrect format"
                fi
              fi
            done
          fi

      - name: Comment on PR if no changeset
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ⚠️ Changelog Required

            This PR contains code changes but no changeset file was found.

            According to the [Changesets documentation](https://github.com/changesets/changesets), please add a changeset file by running:
            \`\`\`bash
            pnpm changeset
            \`\`\`

            Or manually create a file in \`.changeset/\` directory with the following format:
            \`\`\`markdown
            ---
            "code-cookies": patch
            ---

            Description of your changes here
            \`\`\`

            See [.changeset/README.md](/.changeset/README.md) for more information.

            **This check must pass before the PR can be merged.**`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('Changelog Required')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
